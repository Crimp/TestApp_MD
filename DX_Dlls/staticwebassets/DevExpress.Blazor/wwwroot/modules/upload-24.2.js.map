{"version":3,"file":"upload-24.2.js","sources":["../../Scripts/upload/upload.ts"],"sourcesContent":["import { getRecentlyAddedFileInfosStream, initDotNetReference, UploadBase } from \"./upload-base\";\r\nimport { ChunkFileUploader, FileStatus, MAX_CONCURRENT_UPLOADS, UploadTechnology, WholeFileUploader } from \"./upload-types\";\r\nexport class DxUpload extends UploadBase {\r\n    constructor() {\r\n        super();\r\n        this.uploaders = new Map();\r\n        this.uploadPromises = new Set();\r\n        this.pendingFiles = new Array();\r\n    }\r\n    processUploadedFilesOptionsCore(uploadedFilesOptions) {\r\n        for (const option of uploadedFilesOptions) {\r\n            if (option.status === FileStatus.PendingUpload && option.uploadStartOptions) {\r\n                this.onUploadStartCallback(option.uploadStartOptions, option.customFormDataOptions);\r\n            }\r\n        }\r\n    }\r\n    onUploadStartCallback(response, customDataResponse) {\r\n        const { guid, requestJSOptions: options } = response;\r\n        const file = this.files.get(guid);\r\n        if (!file)\r\n            return;\r\n        this.attachEventsToFileItem(file);\r\n        if (!options) {\r\n            file.abort();\r\n            return;\r\n        }\r\n        if (this.uploadTechnology === UploadTechnology.Http && !options.uploadUrl) {\r\n            file.error(new EventTarget());\r\n            return;\r\n        }\r\n        this.startUpload(file, options, (customDataResponse === null || customDataResponse === void 0 ? void 0 : customDataResponse.customData) || {});\r\n    }\r\n    startUpload(file, requestOptions, customData) {\r\n        file.status = FileStatus.PendingUpload;\r\n        this.scheduleUpload(file, requestOptions, customData);\r\n    }\r\n    handleUploadError(err, file) {\r\n        var _a;\r\n        if (err && err.status && err.statusText && err.responseText)\r\n            (_a = file.onError) === null || _a === void 0 ? void 0 : _a.call(file, err);\r\n    }\r\n    scheduleUpload(file, requestOptions, customData) {\r\n        if (this.uploadPromises.size < MAX_CONCURRENT_UPLOADS) {\r\n            const filePromise = this.uploadFileCore(file, requestOptions, customData);\r\n            this.uploadPromises.add(filePromise);\r\n            filePromise\r\n                .catch((err) => this.handleUploadError(err, file))\r\n                .finally(() => {\r\n                this.onAfterUpload(filePromise);\r\n            });\r\n        }\r\n        else {\r\n            // Promise.race(this.uploadPromises).then(() => this.scheduleUpload(file, requestOptions, customData));\r\n            this.pendingFiles.push({ file, requestOptions, customData });\r\n        }\r\n    }\r\n    onAfterUpload(filePromise) {\r\n        this.uploadPromises.delete(filePromise);\r\n        if (this.pendingFiles.length > 0) {\r\n            const pendingFile = this.pendingFiles.shift();\r\n            const newFile = pendingFile.file;\r\n            const newFilePromise = this.uploadFileCore(newFile, pendingFile.requestOptions, pendingFile.customData);\r\n            this.uploadPromises.add(newFilePromise);\r\n            newFilePromise\r\n                .catch((err) => this.handleUploadError(err, newFile))\r\n                .finally(() => {\r\n                this.onAfterUpload(newFilePromise);\r\n            });\r\n        }\r\n    }\r\n    getUploadStrategy(file) {\r\n        const newUploadStrategy = this.chunkSize > 0 ? new ChunkFileUploader(this) : new WholeFileUploader(this);\r\n        const oldUploadStrategy = this.uploaders.get(file.fileInfo.guid);\r\n        if (oldUploadStrategy !== newUploadStrategy && file.status !== FileStatus.Uploading || !oldUploadStrategy)\r\n            this.uploaders.set(file.fileInfo.guid, newUploadStrategy);\r\n        return this.uploaders.get(file.fileInfo.guid);\r\n    }\r\n    uploadFileCore(file, requestOptions, customData) {\r\n        return this.getUploadStrategy(file).upload(file, requestOptions, customData, file => {\r\n            file.loadEnd();\r\n            if (!file.isUploadComplete() && file.status === FileStatus.Uploading)\r\n                return this.uploadFileCore(file, requestOptions, null);\r\n            else\r\n                return Promise.resolve();\r\n        });\r\n    }\r\n    onCustomizeFormDataCallback(response) {\r\n        var _a;\r\n        const fileId = response.fileGuid;\r\n        (_a = this.uploaders.get(fileId)) === null || _a === void 0 ? void 0 : _a.onCustomizeChunkMetadataResponse(response.customData);\r\n        this.uploaders.delete(fileId);\r\n    }\r\n}\r\ncustomElements.define(\"dxbl-upload\", DxUpload);\r\nfunction loadModule() { }\r\nexport default { loadModule, initDotNetReference, getRecentlyAddedFileInfosStream };\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;AAEO,MAAM,QAAQ,SAAS,UAAU,CAAC;AACzC,IAAI,WAAW,GAAG;AAClB,QAAQ,KAAK,EAAE,CAAC;AAChB,QAAQ,IAAI,CAAC,SAAS,GAAG,IAAI,GAAG,EAAE,CAAC;AACnC,QAAQ,IAAI,CAAC,cAAc,GAAG,IAAI,GAAG,EAAE,CAAC;AACxC,QAAQ,IAAI,CAAC,YAAY,GAAG,IAAI,KAAK,EAAE,CAAC;AACxC,KAAK;AACL,IAAI,+BAA+B,CAAC,oBAAoB,EAAE;AAC1D,QAAQ,KAAK,MAAM,MAAM,IAAI,oBAAoB,EAAE;AACnD,YAAY,IAAI,MAAM,CAAC,MAAM,KAAK,UAAU,CAAC,aAAa,IAAI,MAAM,CAAC,kBAAkB,EAAE;AACzF,gBAAgB,IAAI,CAAC,qBAAqB,CAAC,MAAM,CAAC,kBAAkB,EAAE,MAAM,CAAC,qBAAqB,CAAC,CAAC;AACpG,aAAa;AACb,SAAS;AACT,KAAK;AACL,IAAI,qBAAqB,CAAC,QAAQ,EAAE,kBAAkB,EAAE;AACxD,QAAQ,MAAM,EAAE,IAAI,EAAE,gBAAgB,EAAE,OAAO,EAAE,GAAG,QAAQ,CAAC;AAC7D,QAAQ,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAC1C,QAAQ,IAAI,CAAC,IAAI;AACjB,YAAY,OAAO;AACnB,QAAQ,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,CAAC;AAC1C,QAAQ,IAAI,CAAC,OAAO,EAAE;AACtB,YAAY,IAAI,CAAC,KAAK,EAAE,CAAC;AACzB,YAAY,OAAO;AACnB,SAAS;AACT,QAAQ,IAAI,IAAI,CAAC,gBAAgB,KAAK,gBAAgB,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE;AACnF,YAAY,IAAI,CAAC,KAAK,CAAC,IAAI,WAAW,EAAE,CAAC,CAAC;AAC1C,YAAY,OAAO;AACnB,SAAS;AACT,QAAQ,IAAI,CAAC,WAAW,CAAC,IAAI,EAAE,OAAO,EAAE,CAAC,kBAAkB,KAAK,IAAI,IAAI,kBAAkB,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAG,kBAAkB,CAAC,UAAU,KAAK,EAAE,CAAC,CAAC;AACvJ,KAAK;AACL,IAAI,WAAW,CAAC,IAAI,EAAE,cAAc,EAAE,UAAU,EAAE;AAClD,QAAQ,IAAI,CAAC,MAAM,GAAG,UAAU,CAAC,aAAa,CAAC;AAC/C,QAAQ,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,cAAc,EAAE,UAAU,CAAC,CAAC;AAC9D,KAAK;AACL,IAAI,iBAAiB,CAAC,GAAG,EAAE,IAAI,EAAE;AACjC,QAAQ,IAAI,EAAE,CAAC;AACf,QAAQ,IAAI,GAAG,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,UAAU,IAAI,GAAG,CAAC,YAAY;AACnE,YAAY,CAAC,EAAE,GAAG,IAAI,CAAC,OAAO,MAAM,IAAI,IAAI,EAAE,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;AACxF,KAAK;AACL,IAAI,cAAc,CAAC,IAAI,EAAE,cAAc,EAAE,UAAU,EAAE;AACrD,QAAQ,IAAI,IAAI,CAAC,cAAc,CAAC,IAAI,GAAG,sBAAsB,EAAE;AAC/D,YAAY,MAAM,WAAW,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,cAAc,EAAE,UAAU,CAAC,CAAC;AACtF,YAAY,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AACjD,YAAY,WAAW;AACvB,iBAAiB,KAAK,CAAC,CAAC,GAAG,KAAK,IAAI,CAAC,iBAAiB,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;AAClE,iBAAiB,OAAO,CAAC,MAAM;AAC/B,gBAAgB,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC;AAChD,aAAa,CAAC,CAAC;AACf,SAAS;AACT,aAAa;AACb;AACA,YAAY,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,cAAc,EAAE,UAAU,EAAE,CAAC,CAAC;AACzE,SAAS;AACT,KAAK;AACL,IAAI,aAAa,CAAC,WAAW,EAAE;AAC/B,QAAQ,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;AAChD,QAAQ,IAAI,IAAI,CAAC,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE;AAC1C,YAAY,MAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;AAC1D,YAAY,MAAM,OAAO,GAAG,WAAW,CAAC,IAAI,CAAC;AAC7C,YAAY,MAAM,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,WAAW,CAAC,cAAc,EAAE,WAAW,CAAC,UAAU,CAAC,CAAC;AACpH,YAAY,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;AACpD,YAAY,cAAc;AAC1B,iBAAiB,KAAK,CAAC,CAAC,GAAG,KAAK,IAAI,CAAC,iBAAiB,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;AACrE,iBAAiB,OAAO,CAAC,MAAM;AAC/B,gBAAgB,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,CAAC;AACnD,aAAa,CAAC,CAAC;AACf,SAAS;AACT,KAAK;AACL,IAAI,iBAAiB,CAAC,IAAI,EAAE;AAC5B,QAAQ,MAAM,iBAAiB,GAAG,IAAI,CAAC,SAAS,GAAG,CAAC,GAAG,IAAI,iBAAiB,CAAC,IAAI,CAAC,GAAG,IAAI,iBAAiB,CAAC,IAAI,CAAC,CAAC;AACjH,QAAQ,MAAM,iBAAiB,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;AACzE,QAAQ,IAAI,iBAAiB,KAAK,iBAAiB,IAAI,IAAI,CAAC,MAAM,KAAK,UAAU,CAAC,SAAS,IAAI,CAAC,iBAAiB;AACjH,YAAY,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC;AACtE,QAAQ,OAAO,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;AACtD,KAAK;AACL,IAAI,cAAc,CAAC,IAAI,EAAE,cAAc,EAAE,UAAU,EAAE;AACrD,QAAQ,OAAO,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE,cAAc,EAAE,UAAU,EAAE,IAAI,IAAI;AAC7F,YAAY,IAAI,CAAC,OAAO,EAAE,CAAC;AAC3B,YAAY,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,IAAI,IAAI,CAAC,MAAM,KAAK,UAAU,CAAC,SAAS;AAChF,gBAAgB,OAAO,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,cAAc,EAAE,IAAI,CAAC,CAAC;AACvE;AACA,gBAAgB,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;AACzC,SAAS,CAAC,CAAC;AACX,KAAK;AACL,IAAI,2BAA2B,CAAC,QAAQ,EAAE;AAC1C,QAAQ,IAAI,EAAE,CAAC;AACf,QAAQ,MAAM,MAAM,GAAG,QAAQ,CAAC,QAAQ,CAAC;AACzC,QAAQ,CAAC,EAAE,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,IAAI,IAAI,EAAE,KAAK,KAAK,CAAC,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,gCAAgC,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;AACxI,QAAQ,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;AACtC,KAAK;AACL,CAAC;AACD,cAAc,CAAC,MAAM,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC;AAC/C,SAAS,UAAU,GAAG,GAAG;AACzB,eAAe,EAAE,UAAU,EAAE,mBAAmB,EAAE,+BAA+B,EAAE;;;;"}