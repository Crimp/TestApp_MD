{"version":3,"file":"positiontracker-24.2.js","sources":["../../Scripts/popup/positiontracker.ts"],"sourcesContent":["import LayoutHelper from \"../utils/layouthelper\";\r\nimport DomHelper from \"../utils/domhelper\";\r\nimport { Rect, RectHelper } from \"../utils/rect\";\r\nimport RafAction from \"../utils/rafaction\";\r\nexport class PositionChangingEvent extends CustomEvent {\r\n    constructor(detail) {\r\n        super(PositionChangingEvent.eventName, {\r\n            detail,\r\n            bubbles: true,\r\n            cancelable: true,\r\n        });\r\n    }\r\n}\r\nPositionChangingEvent.eventName = \"dxbl-position-changing\";\r\nexport class PositionChangedEvent extends CustomEvent {\r\n    constructor(detail) {\r\n        super(PositionChangedEvent.eventName, {\r\n            detail,\r\n            bubbles: true,\r\n            cancelable: true,\r\n        });\r\n    }\r\n}\r\nPositionChangedEvent.eventName = \"dxbl-position-changed\";\r\nexport class PositionTracker extends HTMLElement {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.observer = null;\r\n        this.targetField = \"\";\r\n        this.listenedIdField = \"\";\r\n        this.elementScrollHandler = this.handleElementScroll.bind(this);\r\n        this.resizeHandler = this.handleResize.bind(this);\r\n        this.mutationObserver = new MutationObserver(this.handleMutations.bind(this));\r\n        this.overflows = [];\r\n        this.resizing = [];\r\n        this.targetElement = null;\r\n        this.rafAction = new RafAction();\r\n    }\r\n    get target() {\r\n        return this.targetField;\r\n    }\r\n    set target(selector) {\r\n        this.targetField = selector;\r\n    }\r\n    get listenerId() {\r\n        return this.listenedIdField;\r\n    }\r\n    set listenerId(listenerId) {\r\n        this.listenedIdField = listenerId;\r\n    }\r\n    connectedCallback() {\r\n        this.initializeObserver();\r\n        this.subscribeToOverflows();\r\n    }\r\n    getTargetBoundingClientRect() {\r\n        if (!this.targetElement)\r\n            return Rect.Empty;\r\n        return RectHelper.fromDomRect(this.targetElement.getBoundingClientRect());\r\n    }\r\n    initializeObserver() {\r\n        this.destroyObserver();\r\n        const targetElement = this.querySelector(this.target);\r\n        if (!targetElement) {\r\n            this.mutationObserver.observe(this, { childList: true, subtree: true });\r\n            return;\r\n        }\r\n        const options = {\r\n            root: targetElement,\r\n            rootMargin: \"0px\",\r\n            threshold: 0\r\n        };\r\n        const callback = function (entries, observer) {\r\n            // console.log(\"intersect\");\r\n        };\r\n        this.observer = new IntersectionObserver(callback, options);\r\n        this.observer.observe(this);\r\n        this.targetElement = targetElement;\r\n    }\r\n    disconnectedCallback() {\r\n        this.destroyObserver();\r\n    }\r\n    destroyObserver() {\r\n        var _a;\r\n        this.mutationObserver.disconnect();\r\n        (_a = this.observer) === null || _a === void 0 ? void 0 : _a.disconnect();\r\n        this.observer = null;\r\n    }\r\n    static get observedAttributes() {\r\n        return [\"target\", \"listener-id\"];\r\n    }\r\n    attributeChangedCallback(name, oldVal, newVal) {\r\n        switch (name) {\r\n            case \"target\":\r\n                this.targetChanged(newVal);\r\n                break;\r\n            case \"listener-id\":\r\n                this.listenerIdChanged(newVal);\r\n        }\r\n    }\r\n    handleMutations(records) {\r\n        const targetElement = this.querySelector(this.target);\r\n        if (!targetElement)\r\n            return;\r\n        this.targetElement = targetElement;\r\n        this.mutationObserver.disconnect();\r\n        this.initializeObserver();\r\n        this.subscribeToOverflows();\r\n    }\r\n    handleResize(entries, observer) {\r\n        this.raisePositionChanging();\r\n        this.rafAction.execute(() => this.raisePositionChanged());\r\n    }\r\n    targetChanged(newVal) {\r\n        this.target = newVal;\r\n        this.initializeObserver();\r\n    }\r\n    listenerIdChanged(newVal) {\r\n        this.listenerId = newVal;\r\n    }\r\n    raisePositionChanging() {\r\n        const event = new PositionChangingEvent({ Tracker: this });\r\n        this.dispatchEvent(event);\r\n    }\r\n    raisePositionChanged() {\r\n        const event = new PositionChangedEvent({ Tracker: this });\r\n        this.dispatchEvent(event);\r\n    }\r\n    subscribeToOverflows() {\r\n        if (!this.targetElement)\r\n            return;\r\n        const overflows = [];\r\n        const resizing = [];\r\n        // eslint-disable-next-line no-restricted-syntax\r\n        for (const node of LayoutHelper.getRootPath(this.targetElement)) {\r\n            const element = node;\r\n            if (!element)\r\n                return;\r\n            const resizeObserver = new ResizeObserver(this.resizeHandler);\r\n            resizeObserver.observe(element, { box: \"border-box\" });\r\n            resizing.push();\r\n            if (!DomHelper.isScrollable(element))\r\n                continue;\r\n            element.addEventListener(\"scroll\", this.elementScrollHandler, { capture: true });\r\n            overflows.push(element);\r\n        }\r\n        this.overflows = overflows;\r\n        this.resizing = resizing;\r\n    }\r\n    unsubscribeFromOverflows() {\r\n        this.overflows.forEach(x => {\r\n            x.removeEventListener(\"scroll\", this.elementScrollHandler);\r\n        });\r\n        this.resizing.forEach(x => {\r\n            x.disconnect();\r\n        });\r\n    }\r\n    handleElementScroll(ev) {\r\n        this.raisePositionChanging();\r\n        this.rafAction.execute(() => this.raisePositionChanged());\r\n    }\r\n}\r\ncustomElements.define(\"dxbl-position-tracker\", PositionTracker);\r\nexport function init() {\r\n}\r\nexport default { init, PositionTracker: PositionTracker };\r\n"],"names":[],"mappings":"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"}